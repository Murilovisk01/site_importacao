{% extends 'core/base.html' %}

{% block title %}Kanban{% endblock %}

{% block content %}
<h2 class="mb-4">Dashboard Tarefas</h2>
<a href="{% url 'criar_tarefa' %}" class="btn btn-primary mb-3">+ Nova Tarefa</a>

<form method="get" class="row mb-4 g-2">
    <div class="col-md-4">
        <select name="membro" class="form-select">
            <option value="">Todos os membros</option>
            {% for membro in membros %}
                <option value="{{ membro.id }}" {% if filtro_membro == membro.id %}selected{% endif %}>
                    {{ membro.username }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-4">
        <input type="text" name="q" class="form-control" placeholder="Buscar por título" value="{{ busca }}">
    </div>

    <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary w-100">Filtrar</button>
    </div>

    {% if filtro_membro or busca %}
    <div class="col-md-2">
        <a href="{% url 'dashboard' %}" class="btn btn-outline-danger w-100">Limpar</a>
    </div>
    {% endif %}
</form>

<div class="row">
    <div class="col-md-4">
        <h4 class="text-center text-secondary">Inicial</h4>
        {% for tarefa in tarefas_inicial %}
            <div class="card mb-3">
                <div class="card-body">
                    <div id="tarefa-{{ tarefa.id }}">
                        <button class="btn btn-success btn-sm iniciar-btn" data-id="{{ tarefa.id }}">Iniciar</button>
                        <button class="btn btn-warning btn-sm pausar-btn d-none" data-id="{{ tarefa.id }}">Pausar</button>
                        <button class="btn btn-danger btn-sm concluir-btn d-none" data-id="{{ tarefa.id }}">Concluir</button>
                        <div class="tempo" id="cronometro-{{ tarefa.id }}"></div>
                    </div>
                    <h5>{{ tarefa.titulo }}</h5>
                    <small>{{ tarefa.sistema }} - {{ tarefa.tipo }}</small><br>
                    <small>Prazo: {{ tarefa.prazo }}</small><br>
                    <small>Atribuido: {{ tarefa.atribuido_para }}</small><br>
                    <a href="{% url 'detalhes_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-info mt-2">Detalhes</a>
                    
                    {% if tarefa.status != 'inicial' %}
                        <a href="{% url 'mover_tarefa' tarefa.id 'inicial' %}" class="btn btn-sm btn-outline-secondary mt-2 ms-1">← Inicial</a>
                    {% endif %}
                    {% if tarefa.status != 'andamento' %}
                        <a href="{% url 'mover_tarefa' tarefa.id 'andamento' %}" class="btn btn-sm btn-outline-warning mt-2 ms-1">↔ Andamento</a>
                    {% endif %}
                    {% if tarefa.status != 'concluida' %}
                        <a href="{% url 'mover_tarefa' tarefa.id 'concluida' %}" class="btn btn-sm btn-outline-success mt-2 ms-1">→ Concluída</a>
                    {% endif %}

                    {% if user == tarefa.criado_por %}
                        <a href="{% url 'excluir_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-danger mt-2 ms-2">Excluir</a>
                    {% endif %}

                </div>
            </div>
        {% empty %}
            <p class="text-muted">Sem tarefas</p>
        {% endfor %}
    </div>

    <div class="col-md-4">
        <h4 class="text-center text-warning">Em andamento</h4>
        {% for tarefa in tarefas_andamento %}
            <div class="card mb-3 border-warning">
                <div class="card-body">
                    <h5>{{ tarefa.titulo }}</h5>
                    <small>{{ tarefa.sistema }} - {{ tarefa.tipo }}</small><br>
                    <small>Prazo: {{ tarefa.prazo }}</small><br>
                    <small>Atribuido: {{ tarefa.atribuido_para }}</small><br>
                    <a href="{% url 'detalhes_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-info mt-2">Detalhes</a>

                    {% if tarefa.status != 'inicial' %}
                    <a href="{% url 'mover_tarefa' tarefa.id 'inicial' %}" class="btn btn-sm btn-outline-secondary mt-2 ms-1">← Inicial</a>
                    {% endif %}
                    {% if tarefa.status != 'andamento' %}
                        <a href="{% url 'mover_tarefa' tarefa.id 'andamento' %}" class="btn btn-sm btn-outline-warning mt-2 ms-1">↔ Andamento</a>
                    {% endif %}
                    {% if tarefa.status != 'concluida' %}
                        <a href="{% url 'mover_tarefa' tarefa.id 'concluida' %}" class="btn btn-sm btn-outline-success mt-2 ms-1">→ Concluída</a>
                    {% endif %}
                    {% if user == tarefa.criado_por %}
                        <a href="{% url 'excluir_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-danger mt-2 ms-2">Excluir</a>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <p class="text-muted">Sem tarefas</p>
        {% endfor %}
    </div>

    <div class="col-md-4">
        <h4 class="text-center text-success">Concluída</h4>
        {% for tarefa in tarefas_concluida %}
            <div class="card mb-3 border-success">
                <div class="card-body">
                    <h5>{{ tarefa.titulo }}</h5>
                    <small>{{ tarefa.sistema }} - {{ tarefa.tipo }}</small><br>
                    <small>Prazo: {{ tarefa.prazo }}</small><br>
                    <small>Atribuido: {{ tarefa.atribuido_para }}</small><br>
                    <a href="{% url 'detalhes_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-info mt-2">Detalhes</a>
                    {% if tarefa.status != 'inicial' %}
                        <a href="{% url 'mover_tarefa' tarefa.id 'inicial' %}" class="btn btn-sm btn-outline-secondary mt-2 ms-1">← Inicial</a>
                    {% endif %}
                    {% if tarefa.status != 'andamento' %}
                        <a href="{% url 'mover_tarefa' tarefa.id 'andamento' %}" class="btn btn-sm btn-outline-warning mt-2 ms-1">↔ Andamento</a>
                    {% endif %}
                    {% if tarefa.status != 'concluida' %}
                        <a href="{% url 'mover_tarefa' tarefa.id 'concluida' %}" class="btn btn-sm btn-outline-success mt-2 ms-1">→ Concluída</a>
                    {% endif %}
                    
                    {% if user == tarefa.criado_por %}
                        <a href="{% url 'excluir_tarefa' tarefa.id %}" class="btn btn-sm btn-outline-danger mt-2 ms-2">Excluir</a>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <p class="text-muted">Sem tarefas</p>
        {% endfor %}
    </div>
</div>
<script>
    const cronometros = {};
    
    function iniciarCronometro(id, inicioStr) {
        const cron = document.getElementById(`cronometro-${id}`);
        const inicio = new Date(inicioStr);
    
        function atualizar() {
            const agora = new Date();
            const diff = Math.floor((agora - inicio) / 1000);
            const h = String(Math.floor(diff / 3600)).padStart(2, '0');
            const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
            const s = String(diff % 60).padStart(2, '0');
            cron.innerText = `⏱ ${h}:${m}:${s}`;
        }
    
        atualizar();
        cronometros[id] = setInterval(atualizar, 1000);
    }
    
    document.querySelectorAll('.iniciar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            fetch(`/tarefa/${id}/iniciar/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.inicio) {
                    iniciarCronometro(id, data.inicio);
                    btn.classList.add('d-none');
                    document.querySelector(`#tarefa-${id} .pausar-btn`).classList.remove('d-none');
                    document.querySelector(`#tarefa-${id} .concluir-btn`).classList.remove('d-none');
                }
            });
        });
    });
    
    document.querySelectorAll('.pausar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            fetch(`/tarefa/${id}/pausar/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            })
            .then(r => r.json())
            .then(data => {
                clearInterval(cronometros[id]);
                location.reload();  // ou atualiza o card dinamicamente
            });
        });
    });
    
    document.querySelectorAll('.concluir-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            fetch(`/tarefa/${id}/concluir/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            })
            .then(r => r.json())
            .then(data => {
                clearInterval(cronometros[id]);
                location.reload();
            });
        });
    });
    </script>
    
{% endblock %}
